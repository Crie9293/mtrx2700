.syntax unified
.thumb

#include "initialise.s"

.global partB

.data
.align
terminating_char: .ascii "$"             @ Custom terminating character

buffer: .space 129
counter: .byte 129

.text

partB:
    BL initialise_power
    BL enable_peripheral_clocks
    BL enable_uart

    @ --- LOAD BUFFER ADDRESSES ---
    LDR R2, =terminating_char
    LDRB R2, [R2]
    LDR R1, =buffer
    LDR R7, =counter
    LDRB R7, [R7]

    MOV R8, #0x00

receive_char:
    LDR R0, =UART
    LDR R4, [R0, USART_ISR]

    @ Error check
    TST R4, 1 << UART_ORE | 1 << UART_FE
    BNE clear_error

    @ Wait for data
    TST R4, 1 << UART_RXNE
    BEQ receive_char

    @ Read character
    LDRB R4, [R0, USART_RDR]

    @ Check for terminating character
    CMP R4, R2
    BEQ store_null

    @ Store character and increment counter
    STRB R4, [R1, R8]
    ADD R8, #1

    @ Check buffer limit
    CMP R8, R3
    BGE store_null            @ If buffer full, terminate

    B receive_char            @ Continue receiving

store_null:
    STRB R2, [R1, R8]        @ Null-terminate the string
    B finish                    @ stop the program

clear_error:
    LDR R4, [R0, USART_ICR]
    ORR R4, 1 << UART_ORECF | 1 << UART_FECF
    STR R4, [R0, USART_ICR]
    B receive_char

finish:
	B finish				@ Infinite loop to stop the program
